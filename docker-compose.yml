version: "3.3"
services:
    server:
        build: ./cms
        ports:
            - "10000:10000" #grpc
            - "8282:8080"   #rest
            - "8383:8181"   #grpc tracing
        environment:
            - MYSQL_CONNECTION=${MYSQL_CONNECTION-root:root@tcp(db)/cms}
            - MEMCACHED_HOST=${MEMCACHED_HOST-memcached:3000}
            - MEMCACHED_USER=${MEMCACHED_USER-memcached}
            - MEMCACHED_PASSWORD=${MEMCACHED_PASSWORD-memcached}
            - STATICHOST_ADDRESS=${STATICHOST_ADDRESS-http://static:8000}
        depends_on:
            - db
            - memcached
            - static
        command: ["/go/src/app/wait-for-it.sh", "--timeout=120", "db:3306", "--", "/go/src/app/wait-for-it.sh", "--timeout=120", "memcached:3000", "--", "go-wrapper", "run"]
    db:
        build: ./cms/mysqlprovider/db 
        volumes:
            - type: volume
              source: db-data
              target: /var/lib/mysql
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD-root}
    memcached:
        image: quay.io/aptible/memcached
        environment:
            - PASSWORD=${MEMCACHED_PASSWORD-memcached}
        command: ["/usr/bin/memcached-sasl"]
    static:
        image: tahurt/docker-devd
        command: ["/=https://storage.googleapis.com/learned-stone-189802.appspot.com/"]

volumes:
    db-data:
